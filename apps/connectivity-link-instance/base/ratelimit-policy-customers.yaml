apiVersion: kuadrant.io/v1
kind: RateLimitPolicy
metadata:
  name: neuralbank-customers-ratelimit
  namespace: neuralbank-stack
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: neuralbank-api-route
    namespace: neuralbank-stack
  limits:
    customers-api-per-user:
      # Conditions: Apply this limit only when:
      # 1. The request path matches /api/customers
      # 2. The authenticated user is "Javier Rodríguez Torres"
      conditions:
        - selector: request.path
          operator: matches
          value: "/api/customers"
        - selector: auth.identity.username
          operator: equals
          value: "Javier Rodríguez Torres"
      # Rate limit: 10 requests per minute
      rates:
        - limit: 10
          window: 1m
      # Counter: Track rate limit per username (allows different limits per user)
      counters:
        - expression: auth.identity.username

